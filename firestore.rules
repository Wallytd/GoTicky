rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Only allow favorites to be a reasonable list length (client-side typed in app code).
    function validFavorites(data) {
      return !('favorites' in data) ||
        (data.favorites is list &&
          data.favorites.size() <= 500);
    }

    // Allow only known roles.
    function roleAllowed(data) {
      return !('role' in data) || data.role in ["customer", "admin"];
    }

    function immutableUid(userId, data) {
      return !('uid' in data) || data.uid == userId;
    }

    // Canonical per-user document keyed by Firebase UID or seeded key.
    // Write is allowed for the owner OR for signed-in seeders writing role=admin (for initial admin import).
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if (
          (isOwner(userId)) ||
          (isSignedIn() && request.resource.data.role == "admin")
        ) &&
        immutableUid(userId, request.resource.data) &&
        validFavorites(request.resource.data) &&
        roleAllowed(request.resource.data);

      // Per-user app settings subcollection, e.g. /users/{uid}/app_settings/preferences
      match /app_settings/{docId} {
        allow read, write: if
          isOwner(userId) ||
          (isSignedIn() &&
            (('email' in request.auth.token && request.auth.token.email == userId) ||
             ('emailLower' in request.auth.token && request.auth.token.emailLower == userId)));
      }
    }

    // Admin profiles collection used for admin control room.
    match /adminProfiles/{adminName} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // Human-friendly user directory index for console/admin inspection.
    // Structure: /userDirectory/{role}/{nameKey}/{uid}
    match /userDirectory/{role}/{nameKey}/{uid} {
      allow write: if isSignedIn();
      allow read: if false;
    }

    // Public, minimal profile index keyed by lowercased email for pre-auth avatar lookup.
    match /publicProfiles/{emailLower} {
      allow read: if true;
      allow write: if isSignedIn() &&
        request.resource.data.emailLower == emailLower;
    }

    // Deny everything else.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
